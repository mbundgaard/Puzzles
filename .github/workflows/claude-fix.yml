name: Claude Auto-Fix

on:
  issue_comment:
    types: [created]

jobs:
  claude-fix:
    # Only run if comment mentions @claude and is on an issue (not PR)
    if: |
      contains(github.event.comment.body, '@claude') &&
      !github.event.issue.pull_request
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Acknowledge request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ü§ñ Claude is analyzing this issue and will create a PR if a fix is found...'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create branch name
        id: branch
        run: |
          BRANCH_NAME="claude/fix-issue-${{ github.event.issue.number }}-$(date +%s)"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude to fix issue
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          git checkout -b "${{ steps.branch.outputs.name }}"

          # Run Claude Code with the fix command
          claude --print "Fix GitHub issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

          Issue description:
          ${{ github.event.issue.body }}

          Instructions:
          1. Analyze the issue and find the relevant code
          2. Implement the fix
          3. Follow the project guidelines in CLAUDE.md
          4. Do NOT update changelog, version, or close the issue - just fix the code
          5. If you cannot fix this issue, create a file called CLAUDE_CANNOT_FIX.md explaining why
          " 2>&1 | tee claude_output.txt

          # Check if Claude made any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

          # Check if Claude couldn't fix it
          if [ -f "CLAUDE_CANNOT_FIX.md" ]; then
            echo "cannot_fix=true" >> $GITHUB_OUTPUT
            echo "cannot_fix_reason=$(cat CLAUDE_CANNOT_FIX.md)" >> $GITHUB_OUTPUT
            rm CLAUDE_CANNOT_FIX.md
          else
            echo "cannot_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.claude.outputs.has_changes == 'true' && steps.claude.outputs.cannot_fix == 'false'
        run: |
          git config user.name "claude-bot"
          git config user.email "claude-bot@users.noreply.github.com"
          git add -A
          git commit -m "Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          git push -u origin "${{ steps.branch.outputs.name }}"

      - name: Create Pull Request
        if: steps.claude.outputs.has_changes == 'true' && steps.claude.outputs.cannot_fix == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fix #${{ github.event.issue.number }}: ${{ github.event.issue.title }}`,
              head: '${{ steps.branch.outputs.name }}',
              base: 'main',
              body: `## Summary\nAutomated fix for #${{ github.event.issue.number }}\n\n## Changes\nGenerated by Claude based on the issue description.\n\n## Test plan\n- [ ] Review the changes\n- [ ] Test the fix manually\n- [ ] Merge if everything looks good\n\n---\n_This PR was automatically created by Claude._`
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ Claude has created a fix! Please review: ${pr.data.html_url}`
            });

      - name: Comment if no changes
        if: steps.claude.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ö†Ô∏è Claude analyzed the issue but did not find any code changes to make. This might require manual investigation.'
            });

      - name: Comment if cannot fix
        if: steps.claude.outputs.cannot_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Claude was unable to fix this issue automatically.\n\n**Reason:**\n${{ steps.claude.outputs.cannot_fix_reason }}`
            });
